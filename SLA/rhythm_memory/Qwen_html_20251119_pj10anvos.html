<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm Memory Experiment</title>
    <script src="http://code.jquery.com/jquery-1.6.2.js" type="text/javascript"></script>
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin: 20px 0;
        }
        
        header {
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 1.8em;
        }
        
        p {
            color: #555;
            font-size: 1.1em;
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .hidden {
            display: none;
        }
        
        .button-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        
        button {
            background: linear-gradient(to bottom, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 160px;
        }
        
        button:hover {
            background: linear-gradient(to bottom, #2980b9, #2573a7);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .input-container {
            text-align: center;
            margin: 20px 0;
        }
        
        input[type="text"] {
            padding: 12px 15px;
            font-size: 1.1em;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 250px;
            margin-top: 10px;
            transition: border 0.3s;
        }
        
        input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
            height: 12px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .instructions-box {
            background-color: #e8f4fc;
            border-left: 4px solid #3498db;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .results-container {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .score-display {
            font-size: 2.5em;
            text-align: center;
            color: #2c3e50;
            margin: 20px 0;
            font-weight: bold;
        }
        
        .trial-info {
            text-align: center;
            margin: 15px 0;
            font-size: 1.2em;
            color: #7f8c8d;
        }
        
        .current-response {
            margin: 20px 0;
            min-height: 30px;
            text-align: center;
            font-size: 1.3em;
            color: #3498db;
            font-weight: bold;
        }
        
        @media (max-width: 600px) {
            .container {
                border-radius: 10px;
            }
            
            header {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.5em;
            }
            
            button {
                min-width: 140px;
                padding: 10px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <header id="questions">
            <h1>Welcome to the Rhythm Memory Experiment</h1>
            <div class="input-container">
                <p>Please enter your participant ID to begin:</p>
                <input type="text" id="ID" placeholder="Enter participant ID">
            </div>
            <div class="button-container">
                <button type="button" id="submitButton">Start Experiment</button>
            </div>
        </header>
        
        <header id="instructions1" class="hidden">
            <h1>Instructions</h1>
            <div class="instructions-box">
                <p>This is a test of your ability to remember rhythms.</p>
                <p>During each trial, you will hear a rhythm repeated three times.</p>
                <p>Once the rhythm stops, repeat the rhythm by pressing the space bar.</p>
            </div>
            <div class="button-container">
                <button type="button" id="Continue1">Continue</button>
            </div>
        </header>
        
        <header id="instructions2" class="hidden">
            <h1>Important</h1>
            <div class="instructions-box">
                <p>Make sure to press the space bar only.</p>
                <p>If you press another key, the test will not record your response, and you will not be able to continue to the next trial.</p>
            </div>
            <div class="button-container">
                <button type="button" id="Continue2">Continue</button>
            </div>
        </header>
        
        <header id="instructions3" class="hidden">
            <h1>Practice Trial</h1>
            <div class="instructions-box">
                <p>Let's try one practice trial.</p>
                <p>When you press the button below, a rhythm will play three times.</p>
                <p>Once it stops, repeat the rhythm by pressing the space bar.</p>
            </div>
            <div class="button-container">
                <button type="button" id="Continue3">Start Practice</button>
            </div>
        </header>
        
        <header id="instructions4" class="hidden">
            <h1>Repeat the Rhythm</h1>
            <div class="instructions-box">
                <p>Now repeat the rhythm by pressing the space bar!</p>
            </div>
            <div class="button-container">
                <button type="button" id="Continue4">Continue</button>
            </div>
        </header>
        
        <header id="instructions5" class="hidden">
            <h1>Ready to Begin</h1>
            <div class="instructions-box">
                <p>Okay, you're ready to start the test!</p>
                <p>There will be ten trials in total.</p>
            </div>
            <div class="button-container">
                <button type="button" id="restartButton">Start Experiment</button>
            </div>
        </header>
        
        <header id="trial" class="hidden">
            <h1>Repeat the Rhythm!</h1>
            <p class="trial-info">Press the space bar to repeat the rhythm.</p>
            <div class="current-response" id="currentResponse">Listening...</div>
            <div class="button-container">
                <button type="button" id="nextTrialButton" class="hidden">Next Trial</button>
            </div>
        </header>
        
        <header id="thanks" class="hidden">
            <h1>Thank You for Participating!</h1>
            <p>The experiment is complete. Thank you for your time and effort.</p>
            <div class="results-container">
                <h2>Your Results</h2>
                <div class="score-display" id="finalScore">Calculating...</div>
                <div id="resultsDetails"></div>
            </div>
        </header>
    </div>

    <script type="text/javascript">
        var response_array = [[],[],[],[],[],[],[],[],[],[]];
        var trial_number = 1;
        var during_instructions = 1;
        var memory_score = 0;
        var subject_ID = "";

        var correct_answers = [];
        correct_answers[0] = ["1","1","0","0","1","1","1","1","1","0","0","1","1"];
        correct_answers[1] = ["1","1","0","1","1","1","1","0","1","0","0","1","1"];
        correct_answers[2] = ["1","1","0","1","1","0","1","1","1","1","0","0","1"];
        correct_answers[3] = ["1","0","1","0","1","1","1","1","1","0","0","1","1"];
        correct_answers[4] = ["1","0","1","1","1","0","1","1","1","0","0","1","1"];
        correct_answers[5] = ["1","1","1","0","0","1","1","0","1","1","1","0","1"];
        correct_answers[6] = ["1","1","0","1","1","1","1","0","0","1","1","0","1"];
        correct_answers[7] = ["1","1","1","1","0","0","1","1","0","1","1","0","1"];
        correct_answers[8] = ["1","1","0","1","0","0","1","1","1","0","1","1","1"];
        correct_answers[9] = ["1","1","1","1","0","1","0","0","1","1","1","0","1"];

        for (var i = 1; i < 12; i++) {
            var stim_sound = (i.toString() + ".flac");
            var toAppend = '<audio id="track' + i.toString() + '"><source src="' + stim_sound + '" /></audio>';
            $('body').append(toAppend);
        }

        $(document).ready(function () {
            updateProgressBar();
            $('#submitButton').click(init);
            $('#Continue1').click(Continue1);
            $('#Continue2').click(Continue2);
            $('#Continue3').click(Continue3);
            $('#Continue4').click(log_space_pressed);
            $('#restartButton').click(start);
            $('#nextTrialButton').click(nextTrial);
        });

        function updateProgressBar() {
            var progress = 0;
            if (trial_number > 1) {
                progress = ((trial_number - 1) / 10) * 100;
            }
            $('#progressBar').css('width', progress + '%');
            $('#trialNumber').text(trial_number);
        }

        function init() {
            subject_ID = document.getElementById("ID").value;
            if (!subject_ID) {
                alert("Please enter your participant ID to continue.");
                return;
            }
            $('#questions').hide();
            $('#instructions1').show();
            updateProgressBar();
        }

        function Continue1() {
            $('#instructions1').hide();
            $('#instructions2').show();
            updateProgressBar();
        }

        function Continue2() {
            $('#instructions2').hide();
            $('#instructions3').show();
            updateProgressBar();
        }

        function Continue3() {
            $('#instructions3').hide();
            var z = document.getElementById('track11');
            z.play();
            z.onended = function() {
                $('#instructions4').show();
                document.addEventListener('keyup', log_space_pressed);
            };
        }

        function log_space_pressed(event) {
            if (event && event.code === 'Space') {
                document.removeEventListener('keyup', log_space_pressed);
            }
            $('#Continue4').hide();
            $('#instructions4').hide();
            $('#instructions5').show();
            updateProgressBar();
        }

        function start() {
            during_instructions = 0;
            $('#instructions5').hide();
            playTrialRhythm();
        }

        function playTrialRhythm() {
            $('#trial').show();
            updateProgressBar();
            $('#currentResponse').text('Listening...');
            $('#nextTrialButton').hide();

            var z = document.getElementById('track' + trial_number.toString());
            z.play();

            z.onended = function () {
                var t0 = performance.now();
                $('#currentResponse').text('Press space bar to repeat the rhythm...');
                document.addEventListener('keyup', function record_space_times(event) {
                    if (event.code === 'Space') {
                        var t1 = performance.now();
                        response_array[trial_number-1].push(t1-t0);
                        t0 = t1;
                    }
                });
                // Enable next trial button after a short delay to allow for rhythm input
                setTimeout(() => {
                    $('#nextTrialButton').show();
                }, 3000); // Adjust delay as needed
            };
        }

        function nextTrial() {
            if (trial_number >= 10) {
                save_data();
            } else {
                trial_number++;
                playTrialRhythm();
            }
        }

        function save_data() {
            memory_score = 0;

            for (var i = 0; i < 10; i++) {
                var time_diff = [];
                for (var j = 1; j < response_array[i].length; j++) {
                    time_diff.push(Math.round((response_array[i][j] - response_array[i][j-1])/200));
                }
                
                var current_vector = ["1"];
                for (var j = 0; j < time_diff.length; j++) {
                    for (var m = 1; m < time_diff[j]; m++) {
                        current_vector.push("0");
                    }
                    current_vector.push("1");
                }

                var current_correct = correct_answers[i];
                while (current_vector.length < 13) {
                    current_vector.push('0');
                }
                current_vector = current_vector.slice(0,13);

                for(var j = 0; j < 13; j++) {
                    if (current_vector[j] === current_correct[j]) {
                        memory_score += 1;
                    }
                }
            }

            var percentage_score = (memory_score / 130) * 100;
            $('#trial').hide();
            $('#thanks').show();
            $('#finalScore').text(percentage_score.toFixed(1) + '%');
            var resultsHTML = '<p>You correctly identified ' + memory_score + ' out of 130 rhythm elements.</p>';
            $('#resultsDetails').html(resultsHTML);
            updateProgressBar();
        }
    </script>
</body>
</html>