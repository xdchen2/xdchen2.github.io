<html>
<head>
    <script src="http://code.jquery.com/jquery-1.6.2.js" type="text/javascript"></script>
    <title>Rhythm memory</title>
    <style type="text/css">
    h1 {text-align: center;}
    p {text-align: center;}
    .hidden 
    {
    	display: none;
    }
    button
    {
    	position: relative
		width: 150px;
    	color: #444444;
    	background-color: LightGray;
    	font-size: 1.2em;
    }
	.buttonbox
    {
        position: relative;
        top: 400px;
        margin: auto;
    }
    </style>
</head>
<body>
    <header id="instructions1">
    <h1>This is a test of your ability to remember rhythms. During each trial you will hear a rhythm repeat three times. Once the rhythm stops, repeat the rhythm by pressing the space bar.</h1>
	</header>
	<header id="instructions2">
    <h1>Make sure to press the space bar; if you press another key the test will not record your responses, and the test will not allow you to continue to the next trial.</h1>
	</header>
	<header id="instructions3">
    <h1>Let's try one practice trial. When you press the button at the bottom of the screen a rhythm will repeat three times. Once the rhythm stops playing, repeat the rhythm by pressing the space bar.</h1>
	</header>
	<header id="instructions4">
    <h1>Repeat the rhythm by pressing the space bar!</h1>
	</header>
	<header id="instructions5">
    <h1>Okay, you're ready to start the test! There will be ten trials in total.</h1>
	</header>
	<header id="trial">
    <h1>Repeat the rhythm by pressing the space bar!</h1>
	</header>
	<header id="questions">
	<div style="text-align:center;">
	  What is your subject id?<br>
	  <br>
	 <input type="text" id="ID" value=""><br>
	</div>
	</header>
	<header id="thanks">
	<h1>Thanks!</h1>
	<p>Thank you! The experiment is concluded.</p>
	</header>
	<div class="buttonbox" style="text-align:center;">
    <button type="button" id="restartButton">Start next trial</button>
	</div>
	<div class="buttonbox" style="text-align:center;">
    <button type="button" id="Continue1">Continue</button>
	</div>
	<div class="buttonbox" style="text-align:center;">
    <button type="button" id="Continue2">Continue</button>
	</div>
	<div class="buttonbox" style="text-align:center;">
    <button type="button" id="Continue3">Continue</button>
	</div>
	<div class="buttonbox" style="text-align:center;">
    <button type="button" id="Continue4">Continue</button>
	</div>
	<div class="buttonbox" style="text-align:center;">
    <button type="button" id="submitButton">Submit answers</button>
	</div>
	
    <script type="text/javascript">
    
    var response_array = [[],[],[],[],[],[],[],[],[],[]];
    var trial_number = 1;
    
    var during_instructions = 1;
    
    var memory_score = 0;
    
    var correct_answers = [];
    correct_answers[0] = ["1","1","0","0","1","1","1","1","1","0","0","1","1"];
    correct_answers[1] = ["1","1","0","1","1","1","1","0","1","0","0","1","1"];
    correct_answers[2] = ["1","1","0","1","1","0","1","1","1","1","0","0","1"];
    correct_answers[3] = ["1","0","1","0","1","1","1","1","1","0","0","1","1"];
    correct_answers[4] = ["1","0","1","1","1","0","1","1","1","0","0","1","1"];
    correct_answers[5] = ["1","1","1","0","0","1","1","0","1","1","1","0","1"];
    correct_answers[6] = ["1","1","0","1","1","1","1","0","0","1","1","0","1"];
    correct_answers[7] = ["1","1","1","1","0","0","1","1","0","1","1","0","1"];
    correct_answers[8] = ["1","1","0","1","0","0","1","1","1","0","1","1","1"];
    correct_answers[9] = ["1","1","1","1","0","1","0","0","1","1","1","0","1"];
	
	var audio_array = [];
	var audio_files = [];
	
	var t0 = 0;
	
	for (var i = 1; i < 12; i++) {
        var stim_sound = (i.toString() + ".flac");
        var toAppend = '<audio id="track' + i.toString() + '"><source src="' + stim_sound + '" /></audio>';
        $('body').append(toAppend);
    }	
	
	$(document).ready(function () {
		$('#questions').show();
		$('#instructions1').hide();
		$('#instructions2').hide();
		$('#instructions3').hide();
		$('#instructions4').hide();
		$('#instructions5').hide();
		$('#thanks').hide();
		$('#trial').hide();
		$('#restartButton').hide();
		$('#Continue1').hide();
		$('#Continue2').hide();
		$('#Continue3').hide();
		$('#Continue4').hide();
		$('#Continue1').click(Continue1);
		$('#Continue2').click(Continue2);
		$('#Continue3').click(Continue3);
		$('#Continue4').click(Continue4);
		$('#submitButton').show();
		$('#submitButton').click(init);
		$('#restartButton').click(start);
    });
    
    function init() {

		subject_ID = document.getElementById("ID").value;
		$('#submitButton').hide();
		$('#Continue1').show();
		$('#instructions1').show();
		$('#questions').hide();
		}
		
	function Continue1() {
	
		$('#Continue1').hide();
		$('#Continue2').show();
		$('#instructions1').hide();
		$('#instructions2').show();
		$('#playButton').show();
	
	}
	
	function Continue2() {
			
		$('#Continue2').hide();
		$('#Continue3').show();
		$('#instructions2').hide();
		$('#instructions3').show();
	
	}
	
	function Continue3() {
	
		$('#Continue3').hide();
		$('#instructions3').hide();
		
		z = document.getElementById('track11');
		z.play();
		z.onended = function() {
		
			$('#instructions4').show();
			document.addEventListener('keyup', log_space_pressed)
		
		}
	
	}
	
	function log_space_pressed(event) {
	
		if (event.code === 'Space') {
  				$('#Continue4').show();
    			document.removeEventListener('keyup', log_space_pressed)
  			}
	
	}
	
	function Continue4() {
		
		$('#Continue4').hide();
		$('#restartButton').show();
		$('#instructions4').hide();
		$('#instructions5').show();
	
	}
	
	function save_data() {
	
	var testString = "";
	testString += "Rhythm memory score: "
	
	for (var i = 1; i < 11; i++) {
	
		var time_diff = [];
	
		for (var j = 1; j < response_array[i-1].length; j++) {
		
			time_diff.push(Math.round((response_array[i-1][j] - response_array[i-1][j-1])/200));
		
		}
		
		var current_vector = [];
		current_vector.push("1");
		
		for (var j = 0; j < time_diff.length; j++) {
		
			for (var m = 1; m < time_diff[j]; m++) {
			
				current_vector.push("0");
			
			}
		
			current_vector.push("1");
		
		}
	
		var current_correct = correct_answers[i-1];
		
		while (current_vector.length < 13) {
		
			current_vector.push('0');
		
		}
		
		current_vector = current_vector.slice(0,13);
		
		for(var j = 1; j < 14; j++) {
		
			if (current_vector[j-1] == current_correct[j-1]) {
			
				memory_score += 1;
			
			}
		
		}
		
	
	}

	memory_score = memory_score / 130;
	memory_score = memory_score * 100;
	
	testString += memory_score.toString();
	var fileContent = testString;
	var bb = new Blob([fileContent ], { type: 'text/plain' });
	var a = document.createElement('a');
	a.download = subject_ID;
	a.download += '_rhythm_memory.txt';
	a.href = window.URL.createObjectURL(bb);
	a.click();
	$('#restartButton').hide();
	$('#trial').hide();
	$('#thanks').show();
	}
	
	function record_space_times(event) {
	
		if (event.code === 'Space') {
  			var t1 = performance.now();
  			response_array[trial_number-2].push(t1-t0);
  			$('#restartButton').show();
  		}
	
	}
	
	function start() {
	
		during_instructions = 0;
	
		if (trial_number > 10) {
	
			save_data()
	
		}
	
		else {
	
			$('#restartButton').hide();
			$('#instructions5').hide();
			$('#trial').hide();
		
        	z = document.getElementById('track' + trial_number.toString());
        	z.play();
			z.onended = function () {
			
				t0 = performance.now();
				trial_number += 1;
				$('#trial').show();
				document.addEventListener('keyup', record_space_times)
  					

				
			}
		
		}
	}

    </script>
</body>
</html>