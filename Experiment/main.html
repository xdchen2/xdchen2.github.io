<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音乐认知实验</title>
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
    <script src="./packages/main-stimuli.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css">
    <link rel="stylesheet" href="./css/new.css">
    <style>
        body {
            font-size: 32px;
            line-height: 1.6;
        }
        h1, h2, h3, h4, h5, h6 {
            font-size: 2.25em;
        }
        p, li, input, button, select {
            font-size: 1.25em;
        }
        .highlight-melody {
            color: #3498db;
            font-weight: bold;
            background-color: rgba(52, 152, 219, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }
        .highlight-lyrics {
            color: #e74c3c;
            font-weight: bold;
            background-color: rgba(231, 76, 60, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }
        .key {
            padding: 10px 20px;
            margin: 0 5px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 8px;
            display: inline-block;
            text-align: center;
            min-width: 120px;
        }
        .key.key-1 { background-color: #2ecc71; color: white; border: 3px solid #27ae60; }
        .key.key-2 { background-color: #27ae60; color: white; border: 3px solid #219653; }
        .key.key-3 { background-color: #f1c40f; color: white; border: 3px solid #d4ac0d; }
        .key.key-4 { background-color: #e67e22; color: white; border: 3px solid #d35400; }
        .key.key-5 { background-color: #e74c3c; color: white; border: 3px solid #c0392b; }
        .consent-container, .instructions, .volume-control-container, 
        .question-container, .feedback, .block-info {
            padding: 30px;
        }
        .consent-btn, .test-button, .continue-btn {
            padding: 15px 30px;
            font-size: 1.2em;
            margin: 15px;
        }
        .volume-slider {
            width: 80%;
            height: 40px;
        }
        .fixation {
            font-size: 4em;
        }
        .response-keys {
            margin-top: 20px;
            display: flex;
            flex-wrap: nowrap;
            justify-content: center;
            gap: 10px;
        }
        .survey-form {
            max-width: 600px;
            margin: 0 auto;
        }
        .survey-form p {
            margin: 10px 0;
            line-height: 1.3;
        }
        .survey-form label {
            display: inline-block;
            width: 150px;
            font-weight: bold;
        }
        .survey-form input, .survey-form select {
            width: 300px;
            padding: 8px;
            font-size: 1em;
            margin-top: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .survey-form button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <div id="jspsych-target"></div>
    <script>
        // Initialize JsPsych
        var jsPsych = initJsPsych({
            on_finish: function () {
                jsPsych.data.get().localSave('csv', 'collected-data.csv');
            },
            show_progress_bar: false,
            message_progress_bar: '总体进度'
        });

        // Consent
        var consent = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
                <div class="consent-container">
                    <h1 class="consent-title">研究知情同意书</h1>
                    <div class="consent-content">
                        <p>感谢您参与本次研究！在您决定是否参与之前，请仔细阅读以下信息：</p>
                        <p><strong>研究目的：</strong>本研究旨在探索人类对音乐<span class="highlight-melody">旋律</span>和<span class="highlight-lyrics">歌词</span>的认知加工过程。通过本实验，我们希望了解人们如何同时处理音乐中的<span class="highlight-melody">旋律</span>和语言信息。</p>
                        <p><strong>实验过程：</strong>整个实验大约需要20-30分钟。在实验中，您将听到一系列音乐片段，然后回答关于这些片段的问题。实验分为练习部分（约5分钟）和正式实验部分（约15-25分钟）。</p>
                        <p><strong>参与要求：</strong>我们希望您满足以下条件：</p>
                        <ul>
                            <li>年龄在18-80岁之间</li>
                            <li>听力正常（或矫正后正常）</li>
                            <li>无神经或精神疾病史</li>
                            <li>母语为中文</li>
                        </ul>
                        <p><strong>隐私保护：</strong>本研究收集的所有数据将严格保密。您的个人信息不会与实验数据关联，所有数据将匿名处理并仅用于科学研究。</p>
                        <p><strong>自愿参与：</strong>您有权随时退出实验，无需提供任何理由，您的权益不会因此受到任何影响。</p>
                        <p><strong>风险预期：</strong>本实验无预期风险。</p>
                        <p>如果您对研究有任何疑问，请联系：xuanda.chen@mail.mcgill.ca</p>
                        <p>点击"我同意"按钮表示您已阅读并理解上述信息，自愿参与本研究。</p>
                    </div>
                    <div class="consent-button-container">
                        <button class="consent-btn consent-agree" id="consent-agree">我同意</button>
                        <button class="consent-btn consent-disagree" id="consent-disagree">我不同意</button>
                    </div>
                </div>
            `,
            choices: "NO_KEYS",
            on_load: function () {
                document.getElementById('consent-agree').addEventListener('click', function () {
                    jsPsych.finishTrial();
                });
                document.getElementById('consent-disagree').addEventListener('click', function () {
                    alert('感谢您的考虑。实验已终止。');
                    window.location.href = 'about:blank';
                });
            }
        };

        // Sound calibration
        var sound_calibration = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
                <div class="volume-control-container">
                    <h2 class="volume-title">声音校准</h2>
                    <p>请调整音量至舒适水平（建议设置为中等音量）</p>
                    <p>点击下方按钮测试声音效果</p>
                    <input type="range" min="0" max="1" step="0.01" value="0.5" class="volume-slider" id="volume-slider">
                    <div>
                        <button class="test-button" id="test-sound">测试声音</button>
                    </div>
                    <div>
                        <button class="continue-btn" id="continue-btn">继续</button>
                    </div>
                </div>
            `,
            choices: "NO_KEYS",
            on_load: function () {
                var audio = new Audio('stimuli/wav/a3.wav');
                audio.volume = 0.5;
                document.getElementById('test-sound').addEventListener('click', function () {
                    audio.currentTime = 0;
                    audio.play();
                });
                document.getElementById('volume-slider').addEventListener('input', function (e) {
                    audio.volume = e.target.value;
                });
                document.getElementById('continue-btn').addEventListener('click', function () {
                    jsPsych.finishTrial();
                });
            }
        };

        // Participant info with dropdowns
        var info = {
            type: jsPsychSurveyHtmlForm,
            preamble: `<p>请提供以下个人信息（所有信息将被严格保密）：</p>`,
            html: `
                <div class="survey-form">
                    <p><label>您的年龄</label>
                        <select name="hearing" required>
                            <option value="" disabled selected>请选择</option>
                            ${Array.from({length: 80}, (_, i) => `<option value="${i}">${i}</option>`).join('')}
                        </select></p>
                    <p><label>您的性别</label>
                        <select name="gender" required>
                            <option value="" disabled selected>请选择</option>
                            <option value="男">男</option>
                            <option value="女">女</option>
                            <option value="其他">其他</option>
                        </select></p>
                    <p><label>教育程度</label>
                        <select name="education" required>
                            <option value="" disabled selected>请选择</option>
                            <option value="高中及以下">高中及以下</option>
                            <option value="大学本科（含函授等）">大学本科（含函授等）</option>
                            <option value="硕士">硕士</option>
                            <option value="博士及以上">博士 & 以上</option>
                        </select></p>
                    <p><label>实验代号</label>
                        <select name="hearing" required>
                            <option value="" disabled selected>请选择</option>
                            ${Array.from({length: 200}, (_, i) => `<option value="${i}">${i}</option>`).join('')}
                        </select></p>
                    <p><label>认知测试</label>
                        <select name="cognitive" required>
                            <option value="" disabled selected>请选择</option>
                            ${Array.from({length: 31}, (_, i) => `<option value="${i}">${i}</option>`).join('')}
                        </select></p>
                    <p><label>听力测试</label>
                        <select name="hearing" required>
                            <option value="" disabled selected>请选择</option>
                            ${Array.from({length: 41}, (_, i) => `<option value="${i}">${i}</option>`).join('')}
                        </select></p>
                </div>
            `,
            button_label: '继续'
        };

        // Task instructions
        var task_instruction = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
                <div class="instructions">
                    <h2>实验说明</h2>
                    <p>在本实验中，您将听到两段旋律（标记为1和2）。</p>
                    <p>您需要根据提示判断两段的<span class="highlight-melody">旋律</span>或<span class="highlight-lyrics">歌词</span>是否一致，使用以下五个选项：</p>
                    <ul>
                        <li><strong>一致：按 1 键</strong></li>
                        <li><strong>似乎一致：按 2 键</strong></li>
                        <li><strong>不确定：按 3 键</strong></li>
                        <li><strong>似乎不一致：按 4 键</strong></li>
                        <li><strong>不一致：按 5 键</strong></li>
                    </ul>
                    <p>实验开始时会有<strong>10个练习trial</strong>帮助您熟悉任务。</p>
                    <p>正式实验包含<strong>4组</strong>，每组约<strong>24-25个trial</strong>，每组之间有休息时间。两组关注<span class="highlight-melody">旋律</span>，两组关注<span class="highlight-lyrics">歌词</span>，交错呈现。</p>
                    <p style="text-align: center; margin-top: 30px;"><strong>按空格键开始练习</strong></p>
                </div>
            `,
            choices: [' ']
        };

        // Practice instructions
        var practice_instruction = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
                <div class="instructions">
                    <h2>练习环节</h2>
                    <p>接下来是<strong>10个练习trial</strong>。</p>
                    <p>在练习环节中，每次回答后您会得到正确与否的反馈。</p>
                    <p>请确保您理解任务要求后再开始正式实验。</p>
                    <p style="text-align: center; margin-top: 30px;"><strong>按空格键开始练习</strong></p>
                </div>
            `,
            choices: [' ']
        };

        // Main experiment instructions
        var main_instruction = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
                <div class="instructions">
                    <h2>正式实验</h2>
                    <p>练习环节已完成，现在开始正式实验。</p>
                    <p>正式实验中不再提供反馈。</p>
                    <p>实验共分为<strong>4组</strong>，每组约<strong>24-25个trial</strong>，每组结束后有休息时间。</p>
                    <p style="text-align: center; margin-top: 30px;"><strong>按空格键开始第一组</strong></p>
                </div>
            `,
            choices: [' ']
        };

        // Fixation point
        var fixation = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div class="fixation">+</div>',
            choices: "NO_KEYS",
            trial_duration: 500
        };

        // Create trial function
        function createTrial(trial, isPractice, blockIndex, trialIndex) {
            var timeline = [];
            if (!isPractice) {
                timeline.push({
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: `<div class="block-info">第 ${blockIndex + 1}/4 组 - 第 ${trialIndex + 1}/${Math.floor(98/4)+1} 个trial</div>`,
                    choices: "NO_KEYS",
                    trial_duration: 1000
                });
            }
            timeline.push(fixation);
            timeline.push({
                type: jsPsychAudioKeyboardResponse,
                prompt: `<p style="text-align: center; font-size: 48px;">正在播放第 1 段...</p>`,
                stimulus: `stimuli/wav/${trial.A}`,
                choices: "NO_KEYS",
                trial_ends_after_audio: true,
            });
            timeline.push(fixation);
            timeline.push({
                type: jsPsychAudioKeyboardResponse,
                prompt: `<p style="text-align: center; font-size: 48px;">正在播放第 2 段...</p>`,
                stimulus: `stimuli/wav/${trial.X}`,
                choices: "NO_KEYS",
                trial_ends_after_audio: true,
            });
            timeline.push({
                type: jsPsychHtmlKeyboardResponse,
                stimulus: `
                    <div class="question-container">
                        <h4>两段<span class="highlight-${trial.task}">${trial.task === 'melody' ? '旋律' : '歌词'}</span>是否一致？</h4>
                        <p> 　 </p>
                        <div class="response-keys">
                            <div class="key key-1">一致 (1)</div>
                            <div class="key key-2">似乎一致 (2)</div>
                            <div class="key key-3">不确定 (3)</div>
                            <div class="key key-4">似乎不一致 (4)</div>
                            <div class="key key-5">不一致 (5)</div>
                        </div>
                    </div>
                `,
                choices: ['1', '2', '3', '4', '5'],
                data: {
                    task: trial.task,
                    correct_response: trial.answer === 'same' ? '1' : '5',
                    trial_id: trial.A + "_" + trial.X,
                    is_practice: isPractice
                },
                on_finish: function (data) {
                    data.correct = data.response === data.correct_response;
                }
            });
            if (isPractice) {
                timeline.push({
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: function () {
                        var last_data = jsPsych.data.get().last(1).values()[0];
                        var correct = last_data.correct;
                        var feedback = `<div class="feedback ${correct ? 'correct' : 'incorrect'}">`;
                        feedback += `<span class="highlight-${last_data.task}">${last_data.task === 'melody' ? '旋律' : '歌词'}</span>判断: ${correct ? '✓ 正确' : '✗ 错误'}</div>`;
                        feedback += '<p style="text-align: center; margin-top: 30px;">按空格键继续</p>';
                        return feedback;
                    },
                    choices: [' ']
                });
            }
            return timeline;
        }

        // Preload audio files
        var preload = {
            type: jsPsychPreload,
            audio: ax_trials.map(trial => `stimuli/wav/${trial.A}`)
                .concat(ax_trials.map(trial => `stimuli/wav/${trial.X}`))
                .concat(practice_trials.map(trial => `stimuli/wav/${trial.A}`))
                .concat(practice_trials.map(trial => `stimuli/wav/${trial.X}`))
        };

        // Split 98 trials into 4 blocks (2 melody, 2 lyrics, interleaved)
        var melody_trials = ax_trials.filter(trial => trial.task === 'melody');
        var lyrics_trials = ax_trials.filter(trial => trial.task === 'lyrics');
        var blocks = [
            melody_trials.slice(0, Math.ceil(melody_trials.length / 2)),
            lyrics_trials.slice(0, Math.ceil(lyrics_trials.length / 2)),
            melody_trials.slice(Math.ceil(melody_trials.length / 2)),
            lyrics_trials.slice(Math.ceil(lyrics_trials.length / 2))
        ];

        // Create block timeline
        var block_timeline = {
            timeline: blocks.map(function (block, block_index) {
                return {
                    timeline: [
                        {
                            type: jsPsychHtmlKeyboardResponse,
                            stimulus: function () {
                                var task_name = block[0].task === 'melody' ? '旋律' : '歌词';
                                return `
                                    <div class="instructions">
                                        <h2>第 ${block_index + 1}/4 组</h2>
                                        <p>本组关注<span class="highlight-${block[0].task}">${task_name}</span>判断，包含${block.length}个trial，预计需要8-10分钟。</p>
                                        <p>请集中注意力，根据听到的内容回答问题。</p>
                                        <p style="text-align: center; margin-top: 30px;"><strong>按空格键开始</strong></p>
                                    </div>
                                `;
                            },
                            choices: [' '],
                            data: { block: block_index }
                        },
                        {
                            timeline: block.map(function (trial, trial_index) {
                                return {
                                    timeline: createTrial(trial, false, block_index, trial_index)
                                };
                            })
                        },
                        {
                            type: jsPsychHtmlKeyboardResponse,
                            stimulus: function () {
                                return `
                                    <div class="instructions">
                                        <h2>休息一下</h2>
                                        <p>您已完成第 ${block_index + 1}/4 组实验。</p>
                                        <p>请短暂休息，准备好后继续下一组。</p>
                                        <p style="text-align: center; margin-top: 30px;"><strong>按空格键继续</strong></p>
                                    </div>
                                `;
                            },
                            choices: [' ']
                        }
                    ]
                };
            })
        };

        // End instructions
        var end_instructions = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
                <div class="instructions">
                    <h2>实验完成</h2>
                    <p>感谢您的参与！</p>
                    <p>您的数据已保存，对研究的贡献非常有价值。</p>
                    <p>如您有任何问题，请联系：xuanda.chen@mail.mcgill.ca</p>
                    <p style="text-align: center; margin-top: 30px;"><strong>按空格键结束实验</strong></p>
                </div>
            `,
            choices: [' ']
        };

        // Assemble full timeline
        var timeline = [];
        timeline.push(consent);
        timeline.push(sound_calibration);
        timeline.push(info);
        timeline.push(preload);
        timeline.push(task_instruction);
        timeline.push(practice_instruction);
        var practice_timeline = [];
        for (var i = 0; i < practice_trials.length; i++) {
            practice_timeline = practice_timeline.concat(createTrial(practice_trials[i], true, 0, i));
        }
        timeline.push({ timeline: practice_timeline });
        timeline.push(main_instruction);
        timeline.push(block_timeline);
        timeline.push(end_instructions);

        // Start experiment
        jsPsych.run(timeline);
    </script>
</body>
</html>